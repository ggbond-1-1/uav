<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— äººæœºå®æ—¶ä½ç½®</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1f2937;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* åŠ¨æ€èƒŒæ™¯åŠ¨ç”» */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
            animation: backgroundShift 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes backgroundShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-10px, -10px) rotate(1deg); }
            50% { transform: translate(10px, -5px) rotate(-1deg); }
            75% { transform: translate(-5px, 10px) rotate(0.5deg); }
        }

        /* å¯¼èˆªæ  */
        .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 20px 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-title {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-button {
            padding: 12px 24px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            cursor: pointer;
            font-size: 16px;
            color: #4b5563;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            margin-left: 15px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .nav-button:hover::before {
            left: 100%;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(102, 126, 234, 0.3);
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* é¡µé¢æ ‡é¢˜ */
        .page-title {
            margin-top: 40px;
            margin-bottom: 30px;
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
            text-align: center;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* åœ°å›¾å®¹å™¨ */
        .map-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px auto;
            position: relative;
            max-width: 800px;
            width: 90%;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .map-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .map-container:hover::before {
            left: 100%;
        }

        .map-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        #drone-map {
            display: block;
            max-width: 100%;
            height: auto;
            border-radius: 15px;
        }

        #position-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 500;
            background: transparent;
        }

        /* ä½ç½®ä¿¡æ¯ */
        .position-info {
            margin-top: 30px;
            font-size: 18px;
            color: #4b5563;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 800px;
            width: 90%;
            transition: all 0.3s ease;
        }

        .position-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .control-panel:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .control-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .control-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .control-button:hover::before {
            left: 100%;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .control-button.stop {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .control-button.stop:hover {
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .control-button.clear {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }

        .control-button.clear:hover {
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
        }

        .control-button.show-all {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .control-button.show-all:hover {
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .control-button.test-collision {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .control-button.test-collision:hover {
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .status-text {
            color: #4b5563;
            font-weight: 500;
            font-size: 14px;
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-title {
            animation: fadeInUp 0.6s ease forwards;
        }

        .map-container {
            animation: fadeInUp 0.8s ease forwards;
        }

        .position-info {
            animation: fadeInUp 1s ease forwards;
        }

        .control-panel {
            animation: fadeInUp 1.2s ease forwards;
        }

        /* å·¦ä¾§è¾¹æ æ ·å¼ */
        .left-sidebar {
            position: fixed;
            left: 0;
            top: 80px;
            width: 320px;
            height: calc(100vh - 80px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            z-index: 100;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
            position: relative;
        }

        .sidebar-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 50px;
            height: 2px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 1px;
        }

        .drone-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .drone-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .drone-card:hover::before {
            left: 100%;
        }

        .drone-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.15);
        }

        .drone-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 12px;
        }

        .drone-icon {
            font-size: 24px;
            color: #667eea;
        }

        .drone-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .drone-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .drone-details {
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .detail-value {
            font-size: 14px;
            color: #1f2937;
            font-weight: 600;
        }

        .distance-info {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .distance-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .distance-value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            text-align: center;
        }

        .show-route-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .show-route-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .show-route-btn:hover::before {
            left: 100%;
        }

        .show-route-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .refresh-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        /* è°ƒæ•´ä¸»å†…å®¹åŒºåŸŸä»¥é€‚åº”ä¾§è¾¹æ  */
        .main-content {
            margin-left: 320px;
            padding: 20px;
            width: calc(100% - 320px);
        }

        .page-title {
            margin-left: 320px;
        }

        .position-info {
            margin-left: 320px;
        }

        .control-panel {
            margin-left: 320px;
        }

        .map-container {
            margin-left: 450px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .left-sidebar {
                position: relative;
                top: 0;
                width: 100%;
                height: auto;
                margin-bottom: 20px;
            }

            .main-content,
            .page-title,
            .position-info,
            .control-panel,
            .map-container {
                margin-left: 0;
                width: 100%;
            }

            .page-title {
                font-size: 28px;
                margin-top: 20px;
            }
            
            .map-container {
                margin: 20px;
                padding: 15px;
            }
            
            .nav-bar {
                padding: 15px 20px;
            }
            
            .nav-button {
                padding: 8px 16px;
                font-size: 14px;
                margin-left: 10px;
            }
            
            .control-panel {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <button class="nav-button" onclick="window.location.href='/users/home/'">è¿”å›</button>
    </nav>

    <!-- å·¦ä¾§è¾¹æ  -->
    <div class="left-sidebar">
        <h3 class="sidebar-title">æ‰§è¡Œä»»åŠ¡æ— äººæœº</h3>
        <button class="show-route-btn refresh-btn" onclick="getActiveDrones()">
            åˆ·æ–°æ— äººæœºä¿¡æ¯
        </button>
        <div id="stats-container" class="drone-card" style="margin-bottom: 20px;">
            <div class="distance-title">å®æ—¶ç»Ÿè®¡</div>
            <div class="detail-row">
                <span class="detail-label">æ´»è·ƒæ— äººæœº:</span>
                <span class="detail-value" id="active-count">0</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">æ€»è·¯å¾„ç‚¹æ•°:</span>
                <span class="detail-value" id="total-paths">0</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">æœ€åæ›´æ–°:</span>
                <span class="detail-value" id="last-update">--</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ç¢°æ’æ£€æµ‹:</span>
                <span class="detail-value" id="collision-status" style="color: #10b981;">ğŸŸ¢ æ­£å¸¸</span>
            </div>
        </div>
        <div id="active-drones-container">
            <!-- åŠ¨æ€ç”Ÿæˆçš„æ— äººæœºå¡ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <div class="page-title">æ— äººæœºå®æ—¶ä½ç½®è¿½è¸ª</div>
    <div class="position-info" id="route-info">æ­£åœ¨åŠ è½½è·¯å¾„ä¿¡æ¯...</div>
    <div class="position-info" id="position-info">ç­‰å¾…æ— äººæœºæ•°æ®...</div>

    <div class="control-panel">
        <button class="control-button start-tracking" onclick="startTrackingWithCheck()">å¼€å§‹è¿½è¸ª</button>
        <button class="control-button stop-tracking" onclick="stopTracking()">åœæ­¢è¿½è¸ª</button>
        <button class="control-button clear-paths" onclick="clearPaths()">æ¸…é™¤è½¨è¿¹</button>
        <button class="control-button show-all" onclick="showAllDrones()">æ˜¾ç¤ºæ‰€æœ‰</button>
        <button class="control-button test-collision" onclick="testCollisionDetection()">æµ‹è¯•ç¢°æ’</button>
    </div>

    <div class="map-container">
        <img id="drone-map" src="" alt="åœ°å›¾" />
        <canvas id="position-canvas" class="drone-path"></canvas>
    </div>

    <script>
        // 1. è°ƒè¯•ï¼šæ‰“å°URLå‚æ•°ï¼Œç¡®è®¤æ˜¯å¦æ­£ç¡®è·å–
        const serialNumber = new URLSearchParams(window.location.search).get('serial');
        const senderAddress = new URLSearchParams(window.location.search).get('sender_address');
        const receiverAddress = new URLSearchParams(window.location.search).get('receiver_address');
        console.log("è·å–åˆ°çš„å‚æ•°ï¼š", { serialNumber, senderAddress, receiverAddress });

        const dronePaths = new Map();
        let collisionAlertShown = false; // é˜²æ­¢é‡å¤æ˜¾ç¤ºç¢°æ’è­¦æŠ¥
        let collisionCheckInterval = null; // ç¢°æ’æ£€æµ‹å®šæ—¶å™¨

        // è®¡ç®—ä¸¤ç‚¹è·ç¦»çš„å‡½æ•°
        function calculateDistance(x1, y1, x2, y2) {
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        // ç¢°æ’æ£€æµ‹å‡½æ•°
        function checkCollision(drones) {
            if (!drones || drones.length < 2) return;
            
            const flyingDrones = drones.filter(drone => 
                drone.current_status === 'in_flight' && drone.current_position
            );
            
            if (flyingDrones.length < 2) return;
            
            // æ£€æŸ¥æ¯å¯¹æ— äººæœºä¹‹é—´çš„è·ç¦»
            for (let i = 0; i < flyingDrones.length; i++) {
                for (let j = i + 1; j < flyingDrones.length; j++) {
                    const drone1 = flyingDrones[i];
                    const drone2 = flyingDrones[j];
                    
                    if (drone1.current_position && drone2.current_position) {
                        const distance = calculateDistance(
                            drone1.current_position.x, drone1.current_position.y,
                            drone2.current_position.x, drone2.current_position.y
                        );
                        
                        // å¦‚æœè·ç¦»å°äº2ä¸ªå•ä½ï¼Œè®¤ä¸ºå‘ç”Ÿç¢°æ’
                        if (distance < 2) {
                            handleCollision(drone1, drone2, distance);
                            return;
                        }
                    }
                }
            }
        }

        // å¤„ç†ç¢°æ’äº‹ä»¶
        function handleCollision(drone1, drone2, distance) {
            if (collisionAlertShown) return; // é˜²æ­¢é‡å¤æ˜¾ç¤º
            
            collisionAlertShown = true;
            
            // æ›´æ–°ç¢°æ’æ£€æµ‹çŠ¶æ€
            const statusElement = document.getElementById('collision-status');
            if (statusElement) {
                statusElement.textContent = 'ğŸ”´ ç¢°æ’è­¦æŠ¥ï¼';
                statusElement.style.color = '#ef4444';
            }
            
            // åœæ­¢æ‰€æœ‰è¿½è¸ª
            stopTracking();
            
            // æ¸…é™¤ç¢°æ’æ£€æµ‹å®šæ—¶å™¨
            if (collisionCheckInterval) {
                clearInterval(collisionCheckInterval);
                collisionCheckInterval = null;
            }
            
            // æ’­æ”¾è­¦æŠ¥å£°éŸ³ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
            playAlarmSound();
            
            // æ˜¾ç¤ºç¢°æ’è­¦æŠ¥å¼¹çª—
            showCollisionAlert(drone1, drone2, distance);
            
            // åœ¨åœ°å›¾ä¸Šé«˜äº®æ˜¾ç¤ºç¢°æ’ä½ç½®
            highlightCollision(drone1, drone2);
            
            // å‘é€ç´§æ€¥åœæ­¢å‘½ä»¤åˆ°åç«¯
            emergencyStop();
        }

        // æ’­æ”¾è­¦æŠ¥å£°éŸ³
        function playAlarmSound() {
            try {
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // è®¾ç½®è­¦æŠ¥éŸ³è°ƒ
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('æ— æ³•æ’­æ”¾è­¦æŠ¥å£°éŸ³:', error);
            }
        }

        // æ˜¾ç¤ºç¢°æ’è­¦æŠ¥å¼¹çª—
        function showCollisionAlert(drone1, drone2, distance) {
            // åˆ›å»ºæ¨¡æ€å¼¹çª—
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            const alertBox = document.createElement('div');
            alertBox.style.cssText = `
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
                padding: 40px;
                border-radius: 20px;
                text-align: center;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease;
                border: 3px solid #fca5a5;
            `;
            
            alertBox.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 20px;">ğŸš¨</div>
                <h2 style="font-size: 28px; margin-bottom: 20px; color: #fef2f2;">ç¢°æ’è­¦æŠ¥ï¼</h2>
                <div style="font-size: 18px; margin-bottom: 15px;">
                    æ£€æµ‹åˆ°æ— äººæœºç¢°æ’é£é™©ï¼
                </div>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="margin-bottom: 10px;">
                        <strong>ç¢°æ’æ— äººæœº:</strong><br>
                        ${drone1.serial_number} (${drone1.model || 'æœªçŸ¥å‹å·'})<br>
                        ä½ç½®: (${drone1.current_position.x}, ${drone1.current_position.y})
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>ä¸:</strong><br>
                        ${drone2.serial_number} (${drone2.model || 'æœªçŸ¥å‹å·'})<br>
                        ä½ç½®: (${drone2.current_position.x}, ${drone2.current_position.y})
                    </div>
                    <div style="color: #fca5a5; font-weight: bold;">
                        è·ç¦»: ${distance.toFixed(2)} å•ä½
                    </div>
                </div>
                <div style="font-size: 16px; margin-bottom: 25px; color: #fef2f2;">
                    æ‰€æœ‰æ— äººæœºå·²ç´§æ€¥åœæ­¢ï¼è¯·ç«‹å³æ£€æŸ¥å¹¶å¤„ç†ã€‚
                </div>
                <button onclick="closeCollisionAlert()" style="
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    padding: 12px 30px;
                    border-radius: 25px;
                    font-size: 16px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    ç¡®è®¤å¹¶å…³é—­
                </button>
            `;
            
            modal.appendChild(alertBox);
            document.body.appendChild(modal);
            
            // æ·»åŠ CSSåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideIn {
                    from { transform: translateY(-50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }

        // å…³é—­ç¢°æ’è­¦æŠ¥
        function closeCollisionAlert() {
            const modal = document.querySelector('div[style*="z-index: 10000"]');
            if (modal) {
                modal.remove();
            }
            collisionAlertShown = false;
            
            // é‡ç½®ç¢°æ’æ£€æµ‹çŠ¶æ€
            const statusElement = document.getElementById('collision-status');
            if (statusElement) {
                statusElement.textContent = 'ğŸŸ¢ æ­£å¸¸';
                statusElement.style.color = '#10b981';
            }
        }

        // åœ¨åœ°å›¾ä¸Šé«˜äº®æ˜¾ç¤ºç¢°æ’ä½ç½®
        function highlightCollision(drone1, drone2) {
            if (!canvasCtx) return;
            
            // æ¸…é™¤ç”»å¸ƒ
            canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);
            
            const pos1 = drone1.current_position;
            const pos2 = drone2.current_position;
            
            const canvasX1 = pos1.y * (canvasCtx.canvas.width / 60);  // Yè½´æ˜ å°„åˆ°Canvasçš„Xè½´
            const canvasY1 = pos1.x * (canvasCtx.canvas.height / 60); // Xè½´æ˜ å°„åˆ°Canvasçš„Yè½´
            const canvasX2 = pos2.y * (canvasCtx.canvas.width / 60);  // Yè½´æ˜ å°„åˆ°Canvasçš„Xè½´
            const canvasY2 = pos2.x * (canvasCtx.canvas.height / 60); // Xè½´æ˜ å°„åˆ°Canvasçš„Yè½´
            
            // ç»˜åˆ¶ç¢°æ’åŒºåŸŸï¼ˆçº¢è‰²åœ†åœˆï¼‰
            canvasCtx.beginPath();
            canvasCtx.arc(canvasX1, canvasY1, 25, 0, 2 * Math.PI);
            canvasCtx.strokeStyle = "#ef4444";
            canvasCtx.lineWidth = 4;
            canvasCtx.setLineDash([10, 5]);
            canvasCtx.stroke();
            canvasCtx.setLineDash([]);
            
            canvasCtx.beginPath();
            canvasCtx.arc(canvasX2, canvasY2, 25, 0, 2 * Math.PI);
            canvasCtx.strokeStyle = "#ef4444";
            canvasCtx.lineWidth = 4;
            canvasCtx.setLineDash([10, 5]);
            canvasCtx.stroke();
            canvasCtx.setLineDash([]);
            
            // ç»˜åˆ¶æ— äººæœºä½ç½®
            canvasCtx.beginPath();
            canvasCtx.arc(canvasX1, canvasY1, 10, 0, 2 * Math.PI);
            canvasCtx.fillStyle = "#ef4444";
            canvasCtx.shadowColor = "#ef4444";
            canvasCtx.shadowBlur = 15;
            canvasCtx.fill();
            
            canvasCtx.beginPath();
            canvasCtx.arc(canvasX2, canvasY2, 10, 0, 2 * Math.PI);
            canvasCtx.fillStyle = "#ef4444";
            canvasCtx.shadowColor = "#ef4444";
            canvasCtx.shadowBlur = 15;
            canvasCtx.fill();
            
            // æ˜¾ç¤ºæ— äººæœºç¼–å·
            canvasCtx.fillStyle = "white";
            canvasCtx.font = "14px Arial";
            canvasCtx.fontWeight = "bold";
            canvasCtx.fillText(drone1.serial_number.slice(-3), canvasX1 + 12, canvasY1 - 12);
            canvasCtx.fillText(drone2.serial_number.slice(-3), canvasX2 + 12, canvasY2 - 12);
            
            // ç»˜åˆ¶è¿æ¥çº¿
            canvasCtx.strokeStyle = "#ef4444";
            canvasCtx.lineWidth = 3;
            canvasCtx.setLineDash([5, 5]);
            canvasCtx.beginPath();
            canvasCtx.moveTo(canvasX1, canvasY1);
            canvasCtx.lineTo(canvasX2, canvasY2);
            canvasCtx.stroke();
            canvasCtx.setLineDash([]);
            
            // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
            document.getElementById('position-info').textContent = 
                `ğŸš¨ ç¢°æ’è­¦æŠ¥ï¼æ— äººæœº ${drone1.serial_number} ä¸ ${drone2.serial_number} å‘ç”Ÿç¢°æ’ | è·ç¦»: ${calculateDistance(pos1.x, pos1.y, pos2.x, pos2.y).toFixed(2)} å•ä½ | æ—¶é—´: ${new Date().toLocaleTimeString()}`;
        }

        // ç´§æ€¥åœæ­¢æ‰€æœ‰æ— äººæœº
        function emergencyStop() {
            console.log('æ‰§è¡Œç´§æ€¥åœæ­¢å‘½ä»¤');
            
            // è¿™é‡Œå¯ä»¥è°ƒç”¨åç«¯APIæ¥åœæ­¢æ‰€æœ‰æ— äººæœº
            fetch('/logistics/api/emergency_stop/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    reason: 'collision_detected',
                    timestamp: new Date().toISOString()
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('ç´§æ€¥åœæ­¢å“åº”:', data);
            })
            .catch(error => {
                console.error('ç´§æ€¥åœæ­¢å¤±è´¥:', error);
            });
        }

        // æµ‹è¯•ç¢°æ’æ£€æµ‹åŠŸèƒ½
        function testCollisionDetection() {
            console.log('æµ‹è¯•ç¢°æ’æ£€æµ‹åŠŸèƒ½');
            
            // åˆ›å»ºæ¨¡æ‹Ÿçš„ç¢°æ’æ•°æ®
            const mockDrone1 = {
                serial_number: 'TEST001',
                model: 'æµ‹è¯•æ— äººæœº1',
                current_status: 'in_flight',
                current_position: { x: 30, y: 30 }
            };
            
            const mockDrone2 = {
                serial_number: 'TEST002',
                model: 'æµ‹è¯•æ— äººæœº2',
                current_status: 'in_flight',
                current_position: { x: 31, y: 31 }
            };
            
            // æ‰‹åŠ¨è§¦å‘ç¢°æ’æ£€æµ‹
            handleCollision(mockDrone1, mockDrone2, 1.41);
        }

        // è·å–å½“å‰æ‰§è¡Œä»»åŠ¡çš„æ— äººæœºä¿¡æ¯
        function getActiveDrones() {
            fetch('/logistics/api/get_all_drones_status/')
                .then(response => response.json())
                .then(data => {
                    console.log('è·å–åˆ°çš„æ— äººæœºæ•°æ®:', data);
                    if (data.success) {
                        // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
                        console.log('æ‰€æœ‰æ— äººæœºæ•°é‡:', data.drones.length);
                        data.drones.forEach((drone, index) => {
                            console.log(`æ— äººæœº ${index + 1}:`, {
                                serial_number: drone.serial_number,
                                current_status: drone.current_status,
                                current_position: drone.current_position,
                                goods_status: drone.goods_status
                            });
                        });
                        
                        // è¿‡æ»¤é£è¡Œä¸­çš„æ— äººæœº
                        const flyingDrones = data.drones.filter(drone => drone.current_status === 'in_flight');
                        console.log('é£è¡Œä¸­çš„æ— äººæœºæ•°é‡:', flyingDrones.length);
                        flyingDrones.forEach((drone, index) => {
                            console.log(`é£è¡Œä¸­æ— äººæœº ${index + 1}:`, drone);
                        });
                        
                        // æ‰§è¡Œç¢°æ’æ£€æµ‹
                        checkCollision(data.drones);
                        
                        updateActiveDronesDisplay(data.drones);
                    } else {
                        console.error('è·å–æ— äººæœºçŠ¶æ€å¤±è´¥:', data.error);
                    }
                })
                .catch(error => {
                    console.error('è·å–æ— äººæœºçŠ¶æ€å‡ºé”™:', error);
                });
        }

        // æ›´æ–°æ´»è·ƒæ— äººæœºæ˜¾ç¤º
        function updateActiveDronesDisplay(drones) {
            const container = document.getElementById('active-drones-container');
            container.innerHTML = '';

            console.log('æ‰€æœ‰æ— äººæœº:', drones);

            // è¿‡æ»¤å‡ºæ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„æ— äººæœº
            const activeDrones = drones.filter(drone => 
                drone.current_status === 'in_flight' && drone.current_position
            );

            console.log('æ´»è·ƒæ— äººæœº:', activeDrones);

            // æ›´æ–°ä¾§è¾¹æ æ ‡é¢˜æ˜¾ç¤ºæ— äººæœºæ•°é‡
            const sidebarTitle = document.querySelector('.sidebar-title');
            if (sidebarTitle) {
                sidebarTitle.textContent = `æ‰§è¡Œä»»åŠ¡æ— äººæœº (${activeDrones.length})`;
            }

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('active-count').textContent = activeDrones.length;
            let totalPaths = 0;
            dronePaths.forEach(path => {
                totalPaths += path.length;
            });
            document.getElementById('total-paths').textContent = totalPaths;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

            if (activeDrones.length === 0) {
                container.innerHTML = '<div class="drone-card"><p style="text-align: center; color: #6b7280;">æš‚æ— æ‰§è¡Œä»»åŠ¡çš„æ— äººæœº</p></div>';
                return;
            }

            activeDrones.forEach(drone => {
                const droneCard = createDroneCard(drone);
                container.appendChild(droneCard);
                
                // ä¸ºæ¯ä¸ªæ´»è·ƒæ— äººæœºè®°å½•è·¯å¾„
                recordDronePath(drone);
            });
        }

        // è®°å½•æ— äººæœºè·¯å¾„
        function recordDronePath(drone) {
            if (!canvasCtx || !drone.current_position) return;
            
            const position = drone.current_position;
            const gridX = position.x;
            const gridY = position.y;
            
            // è®¡ç®—Canvasåæ ‡ï¼ˆç«–ç€æ˜¯Xè½´ï¼Œæ¨ªç€æ˜¯Yè½´ï¼‰
            const canvasX = gridY * (canvasCtx.canvas.width / 60);  // Yè½´æ˜ å°„åˆ°Canvasçš„Xè½´
            const canvasY = gridX * (canvasCtx.canvas.height / 60); // Xè½´æ˜ å°„åˆ°Canvasçš„Yè½´
            
            // è®°å½•è½¨è¿¹
            if (!dronePaths.has(drone.serial_number)) {
                dronePaths.set(drone.serial_number, []);
            }
            const path = dronePaths.get(drone.serial_number);
            path.push({x: canvasX, y: canvasY});
            if (path.length > 50) path.shift();
        }

        // åˆ›å»ºæ— äººæœºå¡ç‰‡
        function createDroneCard(drone) {
            const card = document.createElement('div');
            card.className = 'drone-card';

            // ABCDç‚¹çš„å®é™…åæ ‡ï¼ˆæ ¹æ®åç«¯ä»£ç ï¼‰
            const abcdPoints = {
                'A': { x: 8, y: 8 },      // å·¦ä¸Šè§’
                'B': { x: 52, y: 8 },     // å·¦ä¸‹è§’ï¼ˆç«–ç€æ˜¯Xè½´ï¼‰
                'C': { x: 8, y: 52 },     // å³ä¸Šè§’ï¼ˆæ¨ªç€æ˜¯Yè½´ï¼‰
                'D': { x: 30, y: 30 }     // ä¸­å¿ƒç‚¹
            };

            // è®¡ç®—åˆ°å„ä¸ªç»ˆç‚¹çš„è·ç¦»
            const currentX = drone.current_position.x;
            const currentY = drone.current_position.y;
            
            let minDistance = Infinity;
            let nearestGoal = 'A';
            
            Object.keys(abcdPoints).forEach(point => {
                const dist = calculateDistance(currentX, currentY, abcdPoints[point].x, abcdPoints[point].y);
                if (dist < minDistance) {
                    minDistance = dist;
                    nearestGoal = point;
                }
            });

            const goalX = abcdPoints[nearestGoal].x;
            const goalY = abcdPoints[nearestGoal].y;

            card.innerHTML = `
                <div class="drone-header">
                    <span class="drone-icon">ğŸš</span>
                    <h4 class="drone-title">${drone.serial_number}</h4>
                    <span class="drone-status">æ‰§è¡Œä¸­</span>
                </div>
                <div class="drone-details">
                    <div class="detail-row">
                        <span class="detail-label">å‹å·:</span>
                        <span class="detail-value">${drone.model || 'æœªçŸ¥'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">å½“å‰ä½ç½®:</span>
                        <span class="detail-value">(${currentX}, ${currentY})</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">æœ€è¿‘ç»ˆç‚¹:</span>
                        <span class="detail-value">${nearestGoal} (${goalX}, ${goalY})</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">è´§ç‰©çŠ¶æ€:</span>
                        <span class="detail-value">${drone.in_transit ? 'æ­£åœ¨é…é€' : (drone.goods_status === 'å·²é€è¾¾' ? 'å·²é€è¾¾' : (drone.goods_status === 'æ— è´§ç‰©' ? 'æ— è´§ç‰©' : 'å¾…é…é€'))}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">æ›´æ–°æ—¶é—´:</span>
                        <span class="detail-value">${new Date().toLocaleTimeString()}</span>
                    </div>
                </div>
                <div class="distance-info">
                    <div class="distance-title">è·ç¦»æœ€è¿‘ç»ˆç‚¹</div>
                    <div class="distance-value">${minDistance.toFixed(2)} å•ä½</div>
                    ${minDistance < 5 ? '<div style="color: #10b981; font-size: 12px; text-align: center; margin-top: 5px;">ğŸš æ¥è¿‘ç»ˆç‚¹ï¼</div>' : ''}
                </div>
                <button class="show-route-btn" onclick="showDroneRoute('${drone.serial_number}')">
                    æ˜¾ç¤ºè·¯çº¿
                </button>
                <button class="show-route-btn" onclick="highlightDrone('${drone.serial_number}')" style="margin-top: 8px; background: linear-gradient(135deg, #f59e0b, #d97706);">
                    é«˜äº®æ˜¾ç¤º
                </button>
                <button class="show-route-btn" onclick="showDroneTarget('${drone.serial_number}', '${nearestGoal}', ${goalX}, ${goalY})" style="margin-top: 8px; background: linear-gradient(135deg, #ef4444, #dc2626);">
                    æ˜¾ç¤ºç›®æ ‡
                </button>
            `;

            return card;
        }

        // æ˜¾ç¤ºæ— äººæœºç›®æ ‡
        function showDroneTarget(droneSerial, targetPoint, targetX, targetY) {
            console.log('æ˜¾ç¤ºæ— äººæœºç›®æ ‡:', droneSerial, targetPoint, targetX, targetY);
            
            // è·å–è¯¥æ— äººæœºçš„å½“å‰ä½ç½®
            fetch('/logistics/api/get_all_drones_status/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const targetDrone = data.drones.find(d => d.serial_number === droneSerial);
                        if (targetDrone?.current_position) {
                            // æ¸…é™¤ç”»å¸ƒ
                            canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);
                            
                            const position = targetDrone.current_position;
                            const gridX = position.x;
                            const gridY = position.y;
                            const canvasX = gridY * (canvasCtx.canvas.width / 60);  // Yè½´æ˜ å°„åˆ°Canvasçš„Xè½´
                            const canvasY = gridX * (canvasCtx.canvas.height / 60); // Xè½´æ˜ å°„åˆ°Canvasçš„Yè½´
                            
                            // è®¡ç®—ç›®æ ‡ç‚¹çš„Canvasåæ ‡
                            const targetCanvasX = targetY * (canvasCtx.canvas.width / 60);  // Yè½´æ˜ å°„åˆ°Canvasçš„Xè½´
                            const targetCanvasY = targetX * (canvasCtx.canvas.height / 60); // Xè½´æ˜ å°„åˆ°Canvasçš„Yè½´
                            
                            // ç»˜åˆ¶æ— äººæœºåˆ°ç›®æ ‡çš„è¿çº¿
                            canvasCtx.strokeStyle = "#ef4444";
                            canvasCtx.lineWidth = 3;
                            canvasCtx.setLineDash([8, 4]);
                            canvasCtx.beginPath();
                            canvasCtx.moveTo(canvasX, canvasY);
                            canvasCtx.lineTo(targetCanvasX, targetCanvasY);
                            canvasCtx.stroke();
                            canvasCtx.setLineDash([]); // é‡ç½®è™šçº¿æ ·å¼
                            
                            // ç»˜åˆ¶æ— äººæœºä½ç½®
                            canvasCtx.beginPath();
                            canvasCtx.arc(canvasX, canvasY, 8, 0, 2 * Math.PI);
                            canvasCtx.fillStyle = "#10b981";
                            canvasCtx.shadowColor = "#10b981";
                            canvasCtx.shadowBlur = 10;
                            canvasCtx.fill();
                            
                            // ç»˜åˆ¶ç›®æ ‡ç‚¹
                            canvasCtx.beginPath();
                            canvasCtx.arc(targetCanvasX, targetCanvasY, 10, 0, 2 * Math.PI);
                            canvasCtx.fillStyle = "#ef4444";
                            canvasCtx.shadowColor = "#ef4444";
                            canvasCtx.shadowBlur = 10;
                            canvasCtx.fill();
                            
                            // æ˜¾ç¤ºæ— äººæœºç¼–å·
                            canvasCtx.fillStyle = "black";
                            canvasCtx.font = "12px Arial";
                            canvasCtx.fillText(droneSerial.slice(-3), canvasX + 10, canvasY - 10);
                            
                            // æ˜¾ç¤ºç›®æ ‡ç‚¹æ ‡è¯†
                            canvasCtx.fillStyle = "white";
                            canvasCtx.font = "14px Arial";
                            canvasCtx.fontWeight = "bold";
                            canvasCtx.fillText(targetPoint, targetCanvasX - 4, targetCanvasY + 4);
                            
                            // è®¡ç®—è·ç¦»
                            const distance = calculateDistance(gridX, gridY, targetX, targetY);
                            
                            // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
                            document.getElementById('position-info').textContent = 
                                `æ— äººæœº ${droneSerial} â†’ ç›®æ ‡ ${targetPoint} | è·ç¦»: ${distance.toFixed(2)} å•ä½ | æœ€åæ›´æ–°: ${new Date().toLocaleTimeString()}`;
                            
                            console.log(`å·²æ˜¾ç¤ºæ— äººæœº ${droneSerial} åˆ°ç›®æ ‡ ${targetPoint} çš„è¿çº¿ï¼Œè·ç¦»: ${distance.toFixed(2)} å•ä½`);
                        } else {
                            document.getElementById('position-info').textContent = 
                                `æ— äººæœº ${droneSerial} æš‚æ— ä½ç½®æ•°æ®`;
                        }
                    }
                })
                .catch(error => {
                    console.error('è·å–æ— äººæœºä½ç½®å¤±è´¥:', error);
                    document.getElementById('position-info').textContent = 
                        `è·å–æ— äººæœº ${droneSerial} ä½ç½®å¤±è´¥`;
                });
        }

        // é«˜äº®æ˜¾ç¤ºç‰¹å®šæ— äººæœº
        function highlightDrone(droneSerial) {
            console.log('é«˜äº®æ˜¾ç¤ºæ— äººæœº:', droneSerial);
            
            // è·å–è¯¥æ— äººæœºçš„å½“å‰ä½ç½®
            fetch('/logistics/api/get_all_drones_status/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const targetDrone = data.drones.find(d => d.serial_number === droneSerial);
                        if (targetDrone?.current_position) {
                            // æ¸…é™¤ç”»å¸ƒ
                            canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);
                            
                            const position = targetDrone.current_position;
                            const gridX = position.x;
                            const gridY = position.y;
                            const canvasX = gridY * (canvasCtx.canvas.width / 60);  // Yè½´æ˜ å°„åˆ°Canvasçš„Xè½´
                            const canvasY = gridX * (canvasCtx.canvas.height / 60); // Xè½´æ˜ å°„åˆ°Canvasçš„Yè½´
                            
                            // ç»˜åˆ¶é«˜äº®åœ†åœˆ
                            canvasCtx.beginPath();
                            canvasCtx.arc(canvasX, canvasY, 20, 0, 2 * Math.PI);
                            canvasCtx.strokeStyle = "#f59e0b";
                            canvasCtx.lineWidth = 3;
                            canvasCtx.stroke();
                            
                            // ç»˜åˆ¶æ— äººæœºä½ç½®
                            canvasCtx.beginPath();
                            canvasCtx.arc(canvasX, canvasY, 8, 0, 2 * Math.PI);
                            canvasCtx.fillStyle = "#f59e0b";
                            canvasCtx.shadowColor = "#f59e0b";
                            canvasCtx.shadowBlur = 15;
                            canvasCtx.fill();
                            
                            // æ˜¾ç¤ºæ— äººæœºç¼–å·
                            canvasCtx.fillStyle = "black";
                            canvasCtx.font = "14px Arial";
                            canvasCtx.fontWeight = "bold";
                            canvasCtx.fillText(droneSerial, canvasX + 12, canvasY - 12);
                            
                            // æ˜¾ç¤ºä½ç½®ä¿¡æ¯
                            canvasCtx.fillStyle = "#374151";
                            canvasCtx.font = "12px Arial";
                            canvasCtx.fillText(`(${gridX}, ${gridY})`, canvasX + 12, canvasY + 4);
                            
                            // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
                            document.getElementById('position-info').textContent = 
                                `é«˜äº®æ˜¾ç¤ºæ— äººæœº ${droneSerial} | ä½ç½®: (${gridX}, ${gridY}) | çŠ¶æ€: ${targetDrone.current_status} | æœ€åæ›´æ–°: ${new Date().toLocaleTimeString()}`;
                            
                            console.log(`å·²é«˜äº®æ˜¾ç¤ºæ— äººæœº ${droneSerial}ï¼Œä½ç½®: (${gridX}, ${gridY})`);
                        } else {
                            document.getElementById('position-info').textContent = 
                                `æ— äººæœº ${droneSerial} æš‚æ— ä½ç½®æ•°æ®`;
                        }
                    }
                })
                .catch(error => {
                    console.error('è·å–æ— äººæœºä½ç½®å¤±è´¥:', error);
                    document.getElementById('position-info').textContent = 
                        `è·å–æ— äººæœº ${droneSerial} ä½ç½®å¤±è´¥`;
                });
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ— äººæœºä½ç½®
        function showAllDrones() {
            console.log('æ˜¾ç¤ºæ‰€æœ‰æ— äººæœºä½ç½®');
            
            // è·å–æ‰€æœ‰æ— äººæœºæ•°æ®
            fetch('/logistics/api/get_all_drones_status/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ¸…é™¤ç”»å¸ƒ
                        canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);
                        
                        let activeCount = 0;
                        
                        const dronePositions = [];
                        
                        data.drones.forEach(drone => {
                            if (drone.current_position) {
                                const position = drone.current_position;
                                const gridX = position.x;
                                const gridY = position.y;
                                const canvasX = gridY * (canvasCtx.canvas.width / 60);  // Yè½´æ˜ å°„åˆ°Canvasçš„Xè½´
                                const canvasY = gridX * (canvasCtx.canvas.height / 60); // Xè½´æ˜ å°„åˆ°Canvasçš„Yè½´
                                
                                dronePositions.push({
                                    serial: drone.serial_number,
                                    x: canvasX,
                                    y: canvasY,
                                    status: drone.current_status
                                });
                                
                                // æ ¹æ®æ— äººæœºçŠ¶æ€é€‰æ‹©é¢œè‰²
                                let color = "#6b7280"; // é»˜è®¤ç°è‰²
                                if (drone.current_status === 'in_flight') {
                                    color = "#10b981"; // ç»¿è‰² - é£è¡Œä¸­
                                    activeCount++;
                                } else if (drone.current_status === 'in_stock') {
                                    color = "#3b82f6"; // è“è‰² - åœ¨åº“
                                } else if (drone.current_status === 'maintenance') {
                                    color = "#f59e0b"; // æ©™è‰² - ç»´æŠ¤ä¸­
                                }
                                
                                // ç»˜åˆ¶æ— äººæœºä½ç½®
                                canvasCtx.beginPath();
                                canvasCtx.arc(canvasX, canvasY, 6, 0, 2 * Math.PI);
                                canvasCtx.fillStyle = color;
                                canvasCtx.shadowColor = color;
                                canvasCtx.shadowBlur = 8;
                                canvasCtx.fill();
                                
                                // æ˜¾ç¤ºæ— äººæœºç¼–å·
                                canvasCtx.fillStyle = "black";
                                canvasCtx.font = "10px Arial";
                                canvasCtx.fillText(drone.serial_number.slice(-3), canvasX + 8, canvasY - 8);
                            }
                        });
                        
                        // ç»˜åˆ¶æ— äººæœºä¹‹é—´çš„è¿çº¿ï¼ˆåªè¿æ¥é£è¡Œä¸­çš„æ— äººæœºï¼‰
                        const flyingDrones = dronePositions.filter(drone => drone.status === 'in_flight');
                        if (flyingDrones.length > 1) {
                            canvasCtx.strokeStyle = "rgba(16, 185, 129, 0.3)";
                            canvasCtx.lineWidth = 2;
                            canvasCtx.setLineDash([5, 5]);
                            
                            for (let i = 0; i < flyingDrones.length - 1; i++) {
                                canvasCtx.beginPath();
                                canvasCtx.moveTo(flyingDrones[i].x, flyingDrones[i].y);
                                canvasCtx.lineTo(flyingDrones[i + 1].x, flyingDrones[i + 1].y);
                                canvasCtx.stroke();
                            }
                            
                            canvasCtx.setLineDash([]); // é‡ç½®è™šçº¿æ ·å¼
                        }
                        
                        // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
                        document.getElementById('position-info').textContent = 
                            `æ˜¾ç¤ºæ‰€æœ‰æ— äººæœºä½ç½® | æ´»è·ƒæ— äººæœº: ${activeCount} | æ€»æ— äººæœº: ${data.drones.length} | æœ€åæ›´æ–°: ${new Date().toLocaleTimeString()}`;
                        
                        console.log(`å·²æ˜¾ç¤ºæ‰€æœ‰æ— äººæœºä½ç½®ï¼Œå…± ${data.drones.length} æ¶æ— äººæœºï¼Œå…¶ä¸­ ${activeCount} æ¶æ´»è·ƒ`);
                    }
                })
                .catch(error => {
                    console.error('è·å–æ‰€æœ‰æ— äººæœºä½ç½®å¤±è´¥:', error);
                    document.getElementById('position-info').textContent = 
                        `è·å–æ‰€æœ‰æ— äººæœºä½ç½®å¤±è´¥: ${error.message}`;
                });
        }

        // æ˜¾ç¤ºæ— äººæœºè·¯çº¿
        function showDroneRoute(droneSerial) {
            console.log('æ˜¾ç¤ºæ— äººæœºè·¯çº¿:', droneSerial);
            
            // è·å–è¯¥æ— äººæœºçš„è·¯å¾„æ•°æ®
            const path = dronePaths.get(droneSerial);
            if (path && path.length > 0) {
                // æ¸…é™¤ç”»å¸ƒ
                canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);
                
                // ç»˜åˆ¶è¯¥æ— äººæœºçš„å®Œæ•´è·¯å¾„
                canvasCtx.strokeStyle = "#667eea";
                canvasCtx.lineWidth = 4;
                canvasCtx.beginPath();
                path.forEach((p, i) => {
                    if (i === 0) canvasCtx.moveTo(p.x, p.y);
                    else canvasCtx.lineTo(p.x, p.y);
                });
                canvasCtx.stroke();
                
                // åœ¨è·¯å¾„èµ·ç‚¹å’Œç»ˆç‚¹æ·»åŠ æ ‡è®°
                if (path.length > 0) {
                    // èµ·ç‚¹æ ‡è®°
                    canvasCtx.beginPath();
                    canvasCtx.arc(path[0].x, path[0].y, 6, 0, 2 * Math.PI);
                    canvasCtx.fillStyle = "#10b981";
                    canvasCtx.fill();
                    
                    // ç»ˆç‚¹æ ‡è®°
                    canvasCtx.beginPath();
                    canvasCtx.arc(path[path.length - 1].x, path[path.length - 1].y, 6, 0, 2 * Math.PI);
                    canvasCtx.fillStyle = "#ef4444";
                    canvasCtx.fill();
                }
                
                // æ˜¾ç¤ºæ— äººæœºç¼–å·
                if (path.length > 0) {
                    const lastPoint = path[path.length - 1];
                    canvasCtx.fillStyle = "black";
                    canvasCtx.font = "12px Arial";
                    canvasCtx.fillText(droneSerial.slice(-4), lastPoint.x + 10, lastPoint.y - 10);
                }
                
                // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
                document.getElementById('position-info').textContent = 
                    `æ˜¾ç¤ºæ— äººæœº ${droneSerial} çš„è·¯çº¿è½¨è¿¹ | è·¯å¾„ç‚¹æ•°: ${path.length} | æœ€åæ›´æ–°: ${new Date().toLocaleTimeString()}`;
                
                console.log(`å·²æ˜¾ç¤ºæ— äººæœº ${droneSerial} çš„è·¯çº¿è½¨è¿¹ï¼Œå…± ${path.length} ä¸ªè·¯å¾„ç‚¹`);
            } else {
                // å¦‚æœæ²¡æœ‰è·¯å¾„æ•°æ®ï¼Œå°è¯•è·å–è¯¥æ— äººæœºçš„å½“å‰ä½ç½®å¹¶æ˜¾ç¤º
                fetch('/logistics/api/get_all_drones_status/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const targetDrone = data.drones.find(d => d.serial_number === droneSerial);
                            if (targetDrone?.current_position) {
                                // æ˜¾ç¤ºå½“å‰ä½ç½®
                                const position = targetDrone.current_position;
                                const gridX = position.x;
                                const gridY = position.y;
                                const canvasX = gridY * (canvasCtx.canvas.width / 60);  // Yè½´æ˜ å°„åˆ°Canvasçš„Xè½´
                                const canvasY = gridX * (canvasCtx.canvas.height / 60); // Xè½´æ˜ å°„åˆ°Canvasçš„Yè½´
                                
                                // æ¸…é™¤ç”»å¸ƒ
                                canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);
                                
                                // ç»˜åˆ¶å½“å‰ä½ç½®
                                canvasCtx.beginPath();
                                canvasCtx.arc(canvasX, canvasY, 8, 0, 2 * Math.PI);
                                canvasCtx.fillStyle = "#667eea";
                                canvasCtx.shadowColor = "#667eea";
                                canvasCtx.shadowBlur = 10;
                                canvasCtx.fill();
                                
                                // æ˜¾ç¤ºæ— äººæœºç¼–å·
                                canvasCtx.fillStyle = "black";
                                canvasCtx.font = "12px Arial";
                                canvasCtx.fillText(droneSerial.slice(-4), canvasX + 10, canvasY - 10);
                                
                                document.getElementById('position-info').textContent = 
                                    `æ— äººæœº ${droneSerial} å½“å‰ä½ç½®ï¼š(${gridX}, ${gridY}) | æš‚æ— è·¯å¾„æ•°æ®`;
                            } else {
                                document.getElementById('position-info').textContent = 
                                    `æ— äººæœº ${droneSerial} æš‚æ— ä½ç½®æ•°æ®`;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('è·å–æ— äººæœºä½ç½®å¤±è´¥:', error);
                        document.getElementById('position-info').textContent = 
                            `è·å–æ— äººæœº ${droneSerial} ä½ç½®å¤±è´¥`;
                    });
            }
        }
        let canvasCtx = null;
        let trackingInterval = null;
        // æ–°å¢ï¼šåœ°å›¾æ ¼å­æ€»æ•°ï¼ˆæ ¹æ®12åœ°å›¾é¡µçš„é€»è¾‘ï¼Œç°åœ¨æ˜¯60x60ï¼‰
        const GRID_SIZE = 60;

        // 2. ä¿®å¤Canvasåˆå§‹åŒ–é€»è¾‘ï¼šç¡®ä¿å°ºå¯¸æ­£ç¡®
        function initCanvas() {
  const mapImg = document.getElementById('drone-map');
  const canvas = document.getElementById('position-canvas');
  mapImg.onload = function() {
    // å¼ºåˆ¶Canvaså°ºå¯¸ä¸åœ°å›¾å›¾ç‰‡çš„å®é™…æ¸²æŸ“å°ºå¯¸å®Œå…¨ä¸€è‡´
    canvas.width = mapImg.offsetWidth;  // ç”¨offsetWidthè€ŒénaturalWidthï¼Œç¡®ä¿åŒ¹é…é¡µé¢ç¼©æ”¾
    canvas.height = mapImg.offsetHeight;
    canvasCtx = canvas.getContext('2d');
  };
  if (mapImg.complete) mapImg.onload(); // å¤„ç†ç¼“å­˜å›¾ç‰‡
}



        function redrawPath() {
            if (!canvasCtx ||!dronePaths.has(serialNumber)) return;
            
            const path = dronePaths.get(serialNumber);
            if (path.length > 1) {
                canvasCtx.strokeStyle = "#ff4444";
                canvasCtx.lineWidth = 3;
                canvasCtx.beginPath();
                path.forEach((p, i) => {
                    if (i === 0) canvasCtx.moveTo(p.x, p.y);
                    else canvasCtx.lineTo(p.x, p.y);
                });
                canvasCtx.stroke();
            }
        }

        // 3. ä¿®å¤åœ°å›¾åŠ è½½ï¼šé€‚é…APIå‚æ•°ï¼Œå¢åŠ é”™è¯¯è°ƒè¯•
        function loadMapImage() {
    const routeInfo = document.getElementById('route-info');
    // éªŒè¯å‚æ•°æ˜¯å¦å­˜åœ¨
    if (!senderAddress ||!receiverAddress) {
        routeInfo.textContent = "é”™è¯¯ï¼šURLä¸­ç¼ºå°‘sender_addressæˆ–receiver_addresså‚æ•°";
        console.error("å‚æ•°ç¼ºå¤±ï¼š", { senderAddress, receiverAddress });
        return;
    }

    // 1. å®šä¹‰12åœ°å›¾é¡µæ”¯æŒçš„åˆæ³•èµ·ç‚¹ç»ˆç‚¹ï¼ˆå•å­—æ¯æ ‡è¯†ï¼‰
    const validPoints = ['A', 'B', 'C', 'D'];
    
    // 2. æ ‡å‡†åŒ–å¤„ç†ï¼šæå–é¦–å­—æ¯å¹¶è½¬æ¢ä¸ºå¤§å†™
    const rawStart = senderAddress.trim().toUpperCase();
    const rawGoal = receiverAddress.trim().toUpperCase();
    
    // 3. æå–æœ‰æ•ˆæ ‡è¯†ï¼ˆä¼˜å…ˆå®Œæ•´åŒ¹é…ï¼Œå¦åˆ™å–é¦–å­—æ¯ï¼‰
    let start = validPoints.includes(rawStart)? rawStart : rawStart.charAt(0);
    let goal = validPoints.includes(rawGoal)? rawGoal : rawGoal.charAt(0);
    
    // 4. æœ€ç»ˆæ ¡éªŒï¼šç¡®ä¿å‚æ•°åœ¨åˆæ³•èŒƒå›´å†…
    if (!validPoints.includes(start)) start = 'A'; // éæ³•å€¼é»˜è®¤A
    if (!validPoints.includes(goal)) goal = 'B';   // éæ³•å€¼é»˜è®¤B
    if (start === goal) goal = validPoints.find(p => p!== start) || 'B'; // é¿å…èµ·ç‚¹ç»ˆç‚¹ç›¸åŒ

    // 5. æ˜¾ç¤ºæ ‡å‡†åŒ–åçš„ä¿¡æ¯ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
    console.log("å‚æ•°æ ‡å‡†åŒ–ï¼š", {
        åŸå§‹èµ·ç‚¹: senderAddress,
        åŸå§‹ç»ˆç‚¹: receiverAddress,
        æ ‡å‡†åŒ–èµ·ç‚¹: start,
        æ ‡å‡†åŒ–ç»ˆç‚¹: goal
    });
    routeInfo.textContent = `æ­£åœ¨åŠ è½½è·¯å¾„ï¼š${start} â†’ ${goal}ï¼ˆå·²æ ‡å‡†åŒ–å‚æ•°ï¼‰`;

    // 6. è°ƒç”¨APIæ—¶ä½¿ç”¨æ ‡å‡†åŒ–åçš„å‚æ•°ï¼ˆä¸12åœ°å›¾é¡µå®Œå…¨ä¸€è‡´ï¼‰
    fetch("/logistics/api/plan_path/", {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken')
        },
        body: JSON.stringify({ 
            start: start,  // ç¡®ä¿æ˜¯A/B/C/D
            goal: goal     // ç¡®ä¿æ˜¯A/B/C/D
        }),
    })
   .then(response => {
        console.log("åœ°å›¾APIå“åº”çŠ¶æ€ï¼š", response.status);
        if (!response.ok) {
            return response.text().then(text => { throw new Error(`APIé”™è¯¯ï¼š${text}`) });
        }
        return response.blob();
    })
   .then(blob => {
        const url = URL.createObjectURL(blob);
        document.getElementById('drone-map').src = url;
        routeInfo.textContent = `è·¯å¾„ä¿¡æ¯ï¼š${start} â†’ ${goal}ï¼ˆåœ°å›¾åŠ è½½æˆåŠŸï¼‰`;
    })
   .catch(error => {
        console.error("åœ°å›¾åŠ è½½å¤±è´¥ï¼š", error);
        routeInfo.textContent = `åœ°å›¾åŠ è½½å¤±è´¥ï¼š${error.message}ï¼ˆå‚æ•°ï¼š${start}â†’${goal}ï¼‰`;
    });
}


        // 4. å®Œå–„CSRFä»¤ç‰Œè·å–
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie!== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            console.log("è·å–åˆ°çš„CSRFä»¤ç‰Œï¼š", cookieValue || "æœªæ‰¾åˆ°");
            return cookieValue;
        }

        // 5. ä¿®å¤ä½ç½®è¿½è¸ªï¼šå¢åŠ æ•°æ®éªŒè¯
        function startTracking() {
            if (trackingInterval) clearInterval(trackingInterval);
            trackingInterval = setInterval(fetchPosition, 3000);
            fetchPosition();
            document.getElementById('position-info').textContent = "å¼€å§‹è¿½è¸ªæ— äººæœºä½ç½®...";
        }

        // å¦‚æœæ²¡æœ‰ç‰¹å®šæ— äººæœºåºåˆ—å·ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ— äººæœº
        function startTrackingAll() {
            if (trackingInterval) clearInterval(trackingInterval);
            trackingInterval = setInterval(showAllDrones, 3000);
            showAllDrones();
            document.getElementById('position-info').textContent = "å¼€å§‹è¿½è¸ªæ‰€æœ‰æ— äººæœºä½ç½®...";
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹å®šæ— äººæœºåºåˆ—å·ï¼Œå†³å®šè°ƒç”¨å“ªä¸ªè¿½è¸ªå‡½æ•°
        function startTrackingWithCheck() {
            if (serialNumber) {
                startTracking();
            } else {
                startTrackingAll();
            }
            
            // é‡æ–°å¯åŠ¨ç¢°æ’æ£€æµ‹
            if (!collisionCheckInterval) {
                collisionCheckInterval = setInterval(() => {
                    getActiveDrones(); // è¿™ä¼šè§¦å‘ç¢°æ’æ£€æµ‹
                }, 2000);
            }
        }

        function stopTracking() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            
            // åœæ­¢ç¢°æ’æ£€æµ‹
            if (collisionCheckInterval) {
                clearInterval(collisionCheckInterval);
                collisionCheckInterval = null;
            }
            
            document.getElementById('position-info').textContent = "å·²åœæ­¢è¿½è¸ª";
        }

        function clearPaths() {
            // æ¸…é™¤æ‰€æœ‰æ— äººæœºçš„è·¯å¾„
            dronePaths.clear();
            if (canvasCtx) {
                canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);
                console.log("å·²æ¸…é™¤æ‰€æœ‰è·¯å¾„");
            }
        }

        // 6. ä¿®å¤åæ ‡æ˜ å°„ï¼šä¸åœ°å›¾å°ºå¯¸ä¸¥æ ¼åŒ¹é…
        function fetchPosition() {
            // å¦‚æœæ²¡æœ‰ç‰¹å®šæ— äººæœºåºåˆ—å·ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ— äººæœº
            if (!serialNumber) {
                showAllDrones();
                return;
            }
            
            fetch("/logistics/api/get_active_drones/")
               .then(response => {
                    if (!response.ok) throw new Error("è·å–æ•°æ®å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š" + response.status);
                    return response.json();
                })
               .then(data => {
                    console.log("è·å–åˆ°çš„æ— äººæœºæ•°æ®ï¼š", data);
                    if (data.success) {
                        const targetDrone = data.drones.find(d => d.serial_number === serialNumber);
                        if (targetDrone?.current_position || targetDrone?.position) {
                            updatePosition(targetDrone);
                        } else {
                            document.getElementById('position-info').textContent = "æœªæ‰¾åˆ°è¯¥æ— äººæœºçš„ä½ç½®æ•°æ®";
                        }
                    } else {
                        throw new Error("APIè¿”å›å¤±è´¥ï¼š" + (data.message || "æœªçŸ¥é”™è¯¯"));
                    }
                })
               .catch(error => {
                    console.error("ä½ç½®è·å–å¤±è´¥ï¼š", error);
                    document.getElementById('position-info').textContent = `è·å–ä½ç½®å¤±è´¥ï¼š${error.message}`;
                });
        }

        function updatePosition(drone) {
            if (!canvasCtx) {
                console.error("Canvasæœªåˆå§‹åŒ–ï¼Œæ— æ³•ç»˜åˆ¶");
                return;
            }

            // éªŒè¯ä½ç½®æ•°æ®å®Œæ•´æ€§ - é€‚é…æ–°çš„APIæ•°æ®ç»“æ„
            const position = drone.current_position || drone.position;
            if (!position || position.x === undefined || position.y === undefined) {
                console.error("ä½ç½®æ•°æ®ä¸å®Œæ•´ï¼š", position);
                return;
            }

            // æ¸…é™¤ç”»å¸ƒ
            canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);

            // æ ¼å­åæ ‡è½¬Canvasåæ ‡ï¼ˆä¸¥æ ¼æŒ‰ç…§åœ°å›¾å°ºå¯¸è®¡ç®—ï¼‰
            const gridX = position.x;
            const gridY = position.y;
            // ç¡®ä¿åæ ‡åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆ0åˆ°GRID_SIZEï¼‰
            if (gridX < 0 || gridX > GRID_SIZE || gridY < 0 || gridY > GRID_SIZE) {
                console.error("æ— æ•ˆçš„æ ¼å­åæ ‡ï¼š", gridX, gridY);
                return;
            }

            // è®¡ç®—Canvasåæ ‡ï¼ˆç«–ç€æ˜¯Xè½´ï¼Œæ¨ªç€æ˜¯Yè½´ï¼‰
            const canvasX = gridY * (canvasCtx.canvas.width / 60);  // Yè½´æ˜ å°„åˆ°Canvasçš„Xè½´
            const canvasY = gridX * (canvasCtx.canvas.height / 60); // Xè½´æ˜ å°„åˆ°Canvasçš„Yè½´
            console.log("åæ ‡æ˜ å°„ï¼š", { gridX, gridY, canvasX, canvasY });

            // è®°å½•è½¨è¿¹
            if (!dronePaths.has(serialNumber)) {
                dronePaths.set(serialNumber, []);
            }
            const path = dronePaths.get(serialNumber);
            path.push({x: canvasX, y: canvasY});
            if (path.length > 50) path.shift();

            // ç»˜åˆ¶è½¨è¿¹çº¿
            if (path.length > 1) {
                canvasCtx.strokeStyle = "#ff4444";
                canvasCtx.lineWidth = 3;
                canvasCtx.beginPath();
                path.forEach((p, i) => {
                    if (i === 0) canvasCtx.moveTo(p.x, p.y);
                    else canvasCtx.lineTo(p.x, p.y);
                });
                canvasCtx.stroke();
            }

            // ç»˜åˆ¶å½“å‰ä½ç½®
            canvasCtx.beginPath();
            canvasCtx.arc(canvasX, canvasY, 8, 0, 2 * Math.PI);
            canvasCtx.fillStyle = "#00ff00";
            canvasCtx.shadowColor = "#00ff00";
            canvasCtx.shadowBlur = 10;
            canvasCtx.fill();

            // æ˜¾ç¤ºæ— äººæœºç¼–å·
            canvasCtx.fillStyle = "black";
            canvasCtx.font = "12px Arial";
            canvasCtx.fillText(serialNumber.slice(-4), canvasX + 10, canvasY - 10);

            // æ›´æ–°ä¿¡æ¯
            document.getElementById('position-info').textContent = 
                `æ— äººæœº ${serialNumber} å®æ—¶ä½ç½®ï¼šæ ¼å­(${gridX}, ${gridY}) | æœ€åæ›´æ–°ï¼š${new Date().toLocaleTimeString()}`;
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = function() {
            initCanvas();
            loadMapImage();
            
            // åˆå§‹åŒ–ä¾§è¾¹æ 
            getActiveDrones();
            
            // æ¯5ç§’æ›´æ–°ä¸€æ¬¡æ— äººæœºä¿¡æ¯
            setInterval(getActiveDrones, 5000);
            
            // å¯åŠ¨ç¢°æ’æ£€æµ‹å®šæ—¶å™¨ï¼ˆæ¯2ç§’æ£€æµ‹ä¸€æ¬¡ï¼‰
            collisionCheckInterval = setInterval(() => {
                getActiveDrones(); // è¿™ä¼šè§¦å‘ç¢°æ’æ£€æµ‹
            }, 2000);
            
            // ç­‰å¾…åœ°å›¾åŠ è½½å®Œæˆåæ˜¾ç¤ºæ‰€æœ‰æ— äººæœº
            setTimeout(() => {
                if (canvasCtx) {
                    showAllDrones();
                }
            }, 3000); // å»¶é•¿åˆ°3ç§’ï¼Œç¡®ä¿åœ°å›¾åŠ è½½å®Œæˆ
        };
    </script>
</body>
</html>